# coding=utf-8
"""
DATE:   2021/7/29
AUTHOR: TesterCC
"""

# 改一个临时脚本用于跳板机端口扫描
import optparse
import time

"""
扫描原理：
1.参数接收
    参数值为要扫描的目标机器IP和端口
2.发送和收取相应包
3.包内容判断

如果要构造TCP请求包
在Python里主要使用的模块为socket和scapy

method 1: socket有一个connect的方法，直接可以对目标IP和端口进行连接尝试并返回结果，无需自己去构建SYN包

python3 port_scan_socket.py 10.0.4.141 22  

todo 改成参数指定，命令行执行，且能在无python环境下运行(pyinstaller打包成可执行文件)。
"""

import socket

socket.setdefaulttimeout(2)


def scan(ip, port_list: list, delay_time=2.2):
    # print("Server %s, Port: %s is scaning" % (ip, port))
    open_map = {}
    tmp_port = []

    for port in port_list:
        time.sleep(delay_time)  # delay
        try:
            port = int(port)
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            # socket.AF_INET 服务间通信      socket.SOCK_STREAM 流式socket，for TCP
            res = sock.connect_ex((ip, port))
            # print(res)
            if res == 0:
                print(f"{port} , Result: OPEN")
                tmp_port.append(str(port))
                open_map[ip] = tmp_port
            else:
                # print("Result: CLOSE")
                pass
            sock.close()
        except socket.gaierror:
            print("Hostname could not be resolved. Exiting...")
        except socket.error:
            print("Can't connect to the server...")

    return open_map


if __name__ == '__main__':
    # ip = sys.argv[1]
    # port = sys.argv[2]
    # scan(ip, port)
    usage = 'python %prog -t/-T ["10.0.4.68", "10.0.4.69", "10.0.4.70"] -p/-P [21, 22, 25, 53, 80, 1080, 3389]'

    # 创建对象实例
    parser = optparse.OptionParser(usage)
    parser.add_option("-t", "-T", dest="target_host", type='str', help='target host ip list', default="10.0.4.69")
    parser.add_option("-p", "-P", dest="post_list", type='str', help='port list', default="22")
    # python ip_port_scanner.py -t 10.0.4.69 -p 22   # 不过这里没用上，后面的程序走的list

    ip_list = ["172.16.12.10"]
    # port_list = [21, 22, 25, 53, 80, 1080, 3389, 5000, 5900, 5901, 6379, 8080, 8888, 9092]
    port_list = [21, 22, 23, 25, 53, 67, 68, 69, 80, 110, 135, 139, 143, 161, 389, 443, 445, 512, 513, 514, 873, 1080,
                 1352, 1433, 1521, 2049, 2181, 3306, 3389, 3690, 4848, 5000, 5432, 5632, 5900, 5901, 6379, 7001, 7002,
                 8069, 8080, 9090, 9092, 9200, 9300, 10000, 11211, 27017, 27018, 50000]
    # port_list = [i for i in range(25,65535)]

    scanner_result = []
    start_time = time.time()
    for ip in ip_list:
        ret = scan(ip, port_list)
        scanner_result.append(ret)
    end_time = time.time() - start_time

    print(f"run time: {end_time} seconds")
    print(scanner_result)  # 可以写入文件或者
