#!/usr/bin/env python
# -*- coding:utf-8 -*-
# @Time : 2020/7/15 11:20 
# @Author : MFC

#  P55

import socket

_dns_cache = {}


def _set_dns_cache():
    def _get_addr_info(*args, **kwargs):
        global _dns_cache
        if args in _dns_cache:
            return _dns_cache[args]

        else:
            _dns_cache[args] = socket._get_addr_info(*args, **kwargs)
            return _dns_cache[args]

    if not hasattr(socket, '_get_addr_info'):
        socket._get_addr_info = socket.getaddrinfo
        socket.getaddrinfo = _get_addr_info


def test_set_dns_cache():
    _set_dns_cache()

    import requests
    r1 = requests.get('http://www.huodongxing.com')
    print("第1次没命中缓存的时间：", str(r1.elapsed.microseconds))
    r2 = requests.get('http://www.huodongxing.com')
    print("第2次没命中缓存的时间：", str(r2.elapsed.microseconds))
    # 实际实验后发现，r2也有请求时间比r1长的情况

if __name__ == '__main__':
    test_set_dns_cache()
