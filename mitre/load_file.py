# coding=utf-8
"""
DATE:   2022/5/12
AUTHOR: TesterCC
"""

from stix2 import Filter
from stix2 import MemoryStore

from stix2.utils import get_type_from_id

"""
https://zhuanlan.zhihu.com/p/311145611

workon mitre_py397
"""

# load location json, 通过bundle加载，确认可用
src = MemoryStore()

CTI_PATH = r"E:\workspace_pentest\attack-stix-data"
ICS_PATH = CTI_PATH + "/ics-attack/ics-attack.json"

src.load_from_file(ICS_PATH)


g0075 = src.query([Filter("external_references.external_id", "=", "G0075")])[0]

print(g0075)


def get_techniques_by_group_software(thesrc, group_stix_id):
    # get the malware, tools that the group uses
    group_uses = [
        r for r in thesrc.relationships(group_stix_id, 'uses', source_only=True)
        if get_type_from_id(r.target_ref) in ['malware', 'tool']
    ]
    # get the technique stix ids that the malware, tools use
    software_uses = thesrc.query([
        Filter('type', '=', 'relationship'),
        Filter('relationship_type', '=', 'uses'),
        Filter('source_ref', 'in', [r.source_ref for r in group_uses])
    ])
    #get the techniques themselves
    return thesrc.query([
        Filter('type', '=', 'attack-pattern'),
        Filter('id', 'in', [r.target_ref for r in software_uses])
    ])

ret = get_techniques_by_group_software(src, "intrusion-set--f047ee18-7985-4946-8bfb-4ed754d3a0dd")

print(ret)