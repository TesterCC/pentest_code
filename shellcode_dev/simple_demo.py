#!/usr/bin/env python
"""
pip install capstone -i https://pypi.tuna.tsinghua.edu.cn/simple
利用Python的capstone库，反编译机器码为汇编格式。
ref:
https://forum.butian.net/share/1244
https://www.capstone-engine.org/lang_python.html
"""

from capstone import *

# step 0, shellcode example
buf = b"\x55\x48\x8b\x05\xb8\x13\x00\x00"

# step 1, setting arch, 创建 Capstone 引擎对象
# # x86
md = Cs(CS_ARCH_X86, CS_MODE_32)

# # x64
# md = Cs(CS_ARCH_X86,CS_MODE_64)
# md.detail = True

# step 2, setting anti-assembly syntax
# # AT&AT风格
# md.syntax = CS_OPT_SYNTAX_ATT    # 未知原因报错

# # Intel风格 - Intel CPU Use
md.syntax = CS_OPT_SYNTAX_INTEL    # 正常

# step 3, format print
for i in md.disasm(buf, 0x00):
    print("0x%x: %s|%d\t%s\t%s" % (
        i.address, " ".join([("%02x" % x) for x in i.bytes]).replace('0x', '').ljust(25, " "), i.size, i.mnemonic,
        i.op_str))
