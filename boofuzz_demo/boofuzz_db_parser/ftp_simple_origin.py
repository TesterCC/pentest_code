#!/usr/bin/env python3
"""Demo FTP fuzzer as a standalone script."""

from boofuzz import *



def resp_all(target, fuzz_data_logger, session, test_case_context, *args, **kwargs):
    print(session.root.id)  # 0
    print(session.root.label)  # __ROOT_NODE__
    # print(session.root.name)
    # print(session.root.number)

    print(f'[D00] {test_case_context.session_variables}')

    # print(dir(test_case_context))
    # fuzz_data_logger.log_info(test_case_context.previous_message.name)

    print('~' * 99)

    try:
        print(target.recv(1024).decode())
        print("=" * 66)
        fuzz_data_logger.log_info(session.last_send)
        print("=" * 66)
        fuzz_data_logger.log_info(session.last_recv)

        # if 'redirectionURL' in target.recv(10240).decode():
        #     fuzz_data_logger.log_check(session.last_send)
    except:
        fuzz_data_logger.log_fail("Unable to connect ...")
        return

    print('--' * 66)


def main():
    """
    This example is a very simple FTP fuzzer. It uses no process monitory
    (procmon) and assumes that the FTP server is already running.
    """
    session = Session(target=Target(connection=TCPSocketConnection("172.16.16.133", 21)))

    define_proto(session=session)

    session.fuzz()


def define_proto(session):
    # disable Black formatting to keep custom indentation
    # fmt: off
    user = Request("user", children=(
        String(name="key", default_value="USER"),
        Delim(name="space", default_value=" "),
        # String(name="val", default_value="anonymous"),
        String(name="val", default_value="ftpuser"),
        Static(name="end", default_value="\r\n"),
    ))

    passw = Request("pass", children=(
        String(name="key", default_value="PASS"),
        Delim(name="space", default_value=" "),
        # String(name="val", default_value="james"),
        String(name="val", default_value="1234567"),
        Static(name="end", default_value="\r\n"),
    ))

    stor = Request("stor", children=(
        String(name="key", default_value="STOR"),
        Delim(name="space", default_value=" "),
        String(name="val", default_value="AAAA"),
        Static(name="end", default_value="\r\n"),
    ))

    retr = Request("retr", children=(
        String(name="key", default_value="RETR"),
        Delim(name="space", default_value=" "),
        String(name="val", default_value="AAAA"),
        Static(name="end", default_value="\r\n"),
    ))
    # fmt: on

    session.connect(user, callback=resp_all)
    session.connect(user, passw, callback=resp_all)
    session.connect(passw, stor)
    session.connect(passw, retr)


def define_proto_static(session):
    """Same protocol, using the static definition style."""
    s_initialize("user")
    s_string("USER")
    s_delim(" ")
    # s_string("anonymous")
    s_string("ftpuser")
    s_static("\r\n")

    s_initialize("pass")
    s_string("PASS")
    s_delim(" ")
    # s_string("james")
    s_string("1234567")
    s_static("\r\n")

    s_initialize("stor")
    s_string("STOR")
    s_delim(" ")
    s_string("AAAA")
    s_static("\r\n")

    s_initialize("retr")
    s_string("RETR")
    s_delim(" ")
    s_string("AAAA")
    s_static("\r\n")

    session.connect(s_get("user"))
    session.connect(s_get("user"), s_get("pass"))
    session.connect(s_get("pass"), s_get("stor"))
    session.connect(s_get("pass"), s_get("retr"))


if __name__ == "__main__":
    main()
