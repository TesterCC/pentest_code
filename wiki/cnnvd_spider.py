import time

import requests
from bs4 import BeautifulSoup
import csv
import urllib3
import json
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# by xq
'''
data=[]
def spider():
    for x in b_list:
        url = "http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD={}".format(x)
        rep = requests.get(url=url, verify=False, timeout=1)
        text = rep.content.decode(encoding="utf-8")
        soup = BeautifulSoup(text, "html.parser")
        b = soup.find('div', class_="detail_xq w770")
        c= b.find('ul')
        d= c.find_all('li')
        n=0
        for i in d:
            if n==3 :
                data.append({i.find('a').text.strip(),x})
            n=n+1

a_list=[]
with open('前20个CVE.csv', 'r') as f:
    reader = csv.reader(f)
    for i in reader:
        a_list.append(i[1])
#print(a_list)

b_list=[]
with open('cnnvd_id.csv', 'r') as f:
    reader = csv.reader(f)
    for i in reader:
        if i[1] in a_list:
            b_list.append(i[0])
spider()
print(data)
'''
a_list=[]
vul_type=[]
def spider():
    data=[]
    print(a_list)
    for x in a_list:
        print(x)
        if x[:3]=='CVE':
            url = "http://www.cnnvd.org.cn/web/vulnerability/queryLds.tag"
            data={"qcvCnnvdid": x}
            json.dumps(data)
            try:
                rep = requests.post(url=url, verify=False, timeout=2,data=data)
            except:
                try:
                    time.sleep(0.5)
                    rep = requests.post(url=url, verify=False, timeout=2,data=data)
                except:
                    try:
                        time.sleep(0.5)
                        rep = requests.post(url=url, verify=False, timeout=2,data=data)
                    except:
                        print('requests failed three time')
                        exit(0)
            text = rep.content.decode(encoding="utf-8")
            soup = BeautifulSoup(text, "html.parser")
            b = soup.find('div', id="vulner_0")
            c= b.find('a')
            vul_type.append({c.text.strip(), x})
    print(vul_type)
with open('150个武器分类表（1018）.csv', 'r') as f:
    reader = csv.reader(f)
    for i in reader:
        a_list.append(i[1])
data=[]
spider()